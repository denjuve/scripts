tosca_definitions_version: cloudify_dsl_1_3

imports:
  - http://www.getcloudify.org/spec/cloudify/4.3/types.yaml
  - plugin:cloudify-openstack-plugin
  - plugin:cloudify-utilities-plugin

inputs:

  username:
    description: OS_USERNAME as specified in Openstack RC file.
    default: ehealth

  password:
    description: Openstack user password.
    default: ehealth

  project_id:
    default: 380b5f21bbab48d6a72c81c6822937e0

  tenant_name:
    description: OS_TENANT_NAME as specified in Openstack RC file.
    default: ehealth

  auth_url:
    description: OS_AUTH_URL as specified in Openstack RC file.
    default: http://10.5.1.95:5000/v3

  user_domain_name:
    default: Default

  region:
    description: OS_REGION_NAME as specified in Openstack RC file.
    default: "RegionOne"

  agent_key_private:
    description: >
      The content of the agent's private key.
    default: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEowIBAAKCAQEA8hEii0ph4V2cLUX0niHPWWdQET9JMRHAwakTvOI1RgfqcPVF
      6sp66XhVQO7Ym/RmEsSA5kY/MW1PQUlF/675Lcf78wUvMisGHgE2N53Lj8H+rUCF
      rM9HSiyZkAM5bM+FO6rCb3nQMcRLjwaK8Mn7iC8xwN+eRjo53nH3ijdxz07HBmyA
      XUMkQ58MPFQJNDvrmhsegwmzmEBUqc+5TbePniAaACnY2AHTk6uJgjXZdIP6h9jj
      /64muMdNHOeg6D+QOMXnpC+k+kE8bKhLx1Yv0zUp4w/XIfcA6nEj8nsu1utKi/za
      N6/nQeDMdEMDNhfdgu+74S6iX1BQMeoPXgonoQIDAQABAoIBAGKug5OfPinevJVk
      SGXSyLHcwTJWx2K+pwMMB2TgHvGutm9YPimKY/MbwD2ZYSqqxpXuD9JQXuCqfD3U
      PjoOvbxhI6Adw/DCw1qmCdFAfcTcRBOjExuw4JInfm7MMbPfIaSCZ4OEeFBhgqAK
      /cdNwEHzY2gKgX6FrCO3+D8bfUUSQGfhNmxifIGARoSY4Hm//X91xAeObSFB83qh
      ZIyKZn+l9Ld3wXZ1GDW9O1ODLVHRwmRtAVe6QAllKIJuk9nU/zAxnKpRW8B5S3Au
      ST5snXJ/EIam3fUug4CzrTzXV8F6zZ7RU8QRy0cBF9CxH21IcXBOXkyVF9RSq1Hs
      eUGrJnECgYEA/R8pldxq1IQuAQCCkvWJCMwJ+PDzrnxDYAG8Af7VUZa4lDxkWAoV
      pHMYN/ywjyWRVQ9k6eCuA6Wbjn/Lj/N57+kl02USqccs8naHjLjsYkmFrnhiGpoV
      n2zgkiaHsqaoPhhc8+SszAzNY/i9Wz8hTG4Q5UixSyV5/N4ZvlDDFx0CgYEA9NHK
      vxARE2kexfyELGkG9wJGu9TFkr4dAny9P0Q9HeZ6AKYSlx5d9A5sT1H3E71K2v5K
      Fk3XQNSDS6J5hBQzvcrySxMuDjii5brlKXJzJ/OjK0ujmj8IvxC9v7LcL43X1eyz
      weZMybInkflo7atTI+hYXCEzWtWWIU3bE0uJd1UCgYB4xvDJ0BWtd7CXy82CH+SW
      LP2pKhesLyDa45j4/sZ8msVR/gsHMzCmekCZHlqEwzE4fBLzwcBmfxPdh77y3gNV
      5VKmLrkcB6y7uLDvBaHNODWwTULKXLFqk8IIGphvNzRaBLf9rCSDbKxoQlzf+ByE
      YpRvQyNNrwEpFjUEaXbdRQKBgEl4vHPiin1cytN4GOKLEoAGutub2z9StroMXW8j
      N4RFqs+PB306q8+WlIKpgpD1+gUG040mBzd5j32fYQB2X6DRyy0ksGmsLZbsI+Hw
      awbOY2WW6Z5c1G8iww9IyjOrSd71jmzehKTzRlTUmNza0bSxAfOEMzlLaCbOirSb
      ssGRAoGBAIGnK5iQsH3E2ReOO96iZMDLgCm6M5ezOUMv8miS1mrslsjA5fGPfWh7
      K3LzLEHZp+d/aYLUHDQHnWUp4HbyyyLeuVq6ZA4jW9OgGVfGEHjs1ksQL0Xpmcau
      1WBc3kdp5B6ZzgRytvKRymQjYGRNMcsk4zNsQpFwkDzuKJifjUMF
      -----END RSA PRIVATE KEY-----

  agent_key_public:
    description: >
      The content of the agent's public key.
    default: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDyESKLSmHhXZwtRfSeIc9ZZ1ARP0kxEcDBqRO84jVGB+pw9UXqynrpeFVA7tib9GYSxIDmRj8xbU9BSUX/rvktx/vzBS8yKwYeATY3ncuPwf6tQIWsz0dKLJmQAzlsz4U7qsJvedAxxEuPBorwyfuILzHA355GOjnecfeKN3HPTscGbIBdQyRDnww8VAk0O+uaGx6DCbOYQFSpz7lNt4+eIBoAKdjYAdOTq4mCNdl0g/qH2OP/ria4x00c56DoP5A4xeekL6T6QTxsqEvHVi/TNSnjD9ch9wDqcSPyey7W60qL/No3r+dB4Mx0QwM2F92C77vhLqJfUFAx6g9eCieh

  agent_user:
    description: >
      The username of the agent running on the instance created from the image.
    default: ubuntu

  image:
    description: >
      An Openstack Image ID. Tested with a Ubuntu 14.04 image.
    type: string
    default: d3a106eb-3675-4bda-9247-6aa942efed87
#ub16-user/passw0rd_auth
#'7f2ce3af-e0bb-451e-bd08-eacc74dcfe82'

  flavor:
    description: >
      An Openstack Flavor ID.
    default: '2'

dsl_definitions:

  openstack_config: &openstack_config
    username: { get_input: username }
    password: { get_input: password }
    project_id: { get_input: project_id }
    auth_url: { get_input: auth_url }
    region: { get_input: region }
    user_domain_name: { get_input: user_domain_name }

node_types:
  instance:
    derived_from: cloudify.openstack.nodes.Server
    properties:
      agent_config:
        default:
          install_method: none
          user: { get_input: agent_user }
          port: 22
          key: { get_input: agent_key_private }
      server:
        default:
          key_name: ''
          image: { get_input: image }
          flavor: { get_input: flavor }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: openstack.nova_plugin.server.create
          inputs:
            args:
              default:
                image: { get_input: image }
                flavor: { get_input: flavor }
                userdata: { get_attribute: [ cloudify_host_cloud_config, cloud_config ] }

node_templates:

  cloudify_host_cloud_config:
    type: cloudify.nodes.CloudInit.CloudConfig
    properties:
      resource_config:
        users:
        - name: { get_input: agent_user }
          groups: sudo
          shell: /bin/bash
          sudo: ['ALL=(ALL) NOPASSWD:ALL']
          ssh-authorized-keys:
          - { get_input: agent_key_public }
#        packages:
#          - [nmap]
        runcmd:
#          - 'echo "127.0.1.1 $(hostname)" | sudo tee -a /etc/hosts'
#          - 'sudo cat /etc/hosts'
          - [echo, "127.0.1.1", "$(hostname)", '|', "sudo", "tee", "-a", "/etc/hosts"]
          - [sudo, cat, "/etc/hosts"]
          - [echo, "epc-enablers_cloud_config1", "> epc-enablers_cloud_config.txt"]
          - [echo, "epc-enablers_cloud_config2", "> ~/epc-enablers_cloud_config.txt"]
          - [echo, "epc-enablers_cloud_config3", ">home/ubuntu/epc-enablers_cloud_config.txt"]
          - [echo, "epc-enablers_cloud_config01", '|', "tee", "-a", "epc-enablers_cloud_config.txt"]
          - [echo, "epc-enablers_cloud_config02", '|', "tee", "-a", "home/ubuntu/epc-enablers_cloud_config.txt"]
          - [echo, "epc-enablers_cloud_config03", '|', "tee", "-a", "~/epc-enablers_cloud_config.txt"]
          - [ip, r, add, "172.16.1.100/32", via, "192.168.4.234", dev, net_d]
          - [ip, r, add, 172.16.1.100/32, via, 192.168.4.234, dev, net_d]
#          - [ip, r, add, 172.16.1.100/32, via, 192.168.4.234, dev, net_d]


  wizard_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: VNFWizardSG
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: 80
        - remote_ip_prefix: 0.0.0.0/0
          port: 5000
        - remote_ip_prefix: 0.0.0.0/0
          port: 22
      openstack_config: *openstack_config


  wizard_vm:
    type: instance
    properties:
      resource_id: 'vnf-wizard'
      openstack_config: *openstack_config
    relationships:
      - type: cloudify.openstack.server_connected_to_security_group
        target: wizard_security_group
      - type: cloudify.relationships.depends_on
        target: cloudify_host_cloud_config
      - target: wizard_deploy_port
        type: cloudify.openstack.server_connected_to_port

  deploy_subnet:
    type: cloudify.openstack.nodes.Subnet
    properties:
      openstack_config: *openstack_config
      use_external_resource: true
      resource_id: c4ef7127-a7db-4871-932b-f5601344b5f2
#'24da7f10-75a8-4410-8792-551fbff9270e'
#    relationships:
#    - type: cloudify.relationships.contained_in
#      target: deploy_network

  deploy_network:
    type: cloudify.openstack.nodes.Network
    properties:
      openstack_config: *openstack_config
      use_external_resource: true
      resource_id: 10a3ac76-8ca7-4cdf-8618-a30485eef379
#'ccd40c40-bf59-4bdb-aec1-8be9b5a8de08'


  wizard_deploy_port:
    type: cloudify.openstack.nodes.Port
    properties:
      openstack_config: *openstack_config
    relationships:
      - type: cloudify.relationships.contained_in
        target: deploy_network
      - type: cloudify.relationships.depends_on
        target: deploy_subnet
#      - type: cloudify.openstack.port_connected_to_floating_ip
#        target: wizard_floatingip
      - type: cloudify.openstack.port_connected_to_security_group
        target: wizard_security_group

#outputs:
#  wizard_ip:
#    value: { get_attribute: [wizard_floatingip, floating_ip_address] }
